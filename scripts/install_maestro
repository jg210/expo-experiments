#!/bin/bash
#
# https://github.com/mobile-dev-inc/Maestro have a "curl | bash" style installer but it:
#
# * doesn't allow multiple versions to be used at same time in home directory.
# * modifies you shell startup script(s).

set -o errexit
set -o nounset
set -o pipefail

SOURCE_DIR="$(readlink -f "$(dirname "${BASH_SOURCE[0]}")"/..)"
. "${SOURCE_DIR}/.common.sh"

VERSION_FILE="${SOURCE_DIR}/.maestro-version"
VERSION=$(cat "$VERSION_FILE")
# E.g.      https://github.com/mobile-dev-inc/Maestro/releases/download/cli-1.39.13/maestro.zip
GITHUB_URL="https://github.com/mobile-dev-inc/Maestro/releases/download/cli-${VERSION}/maestro.zip"

INSTALL_MAESTRO_DIR=~/.install_maestro
CACHE_DIR="${INSTALL_MAESTRO_DIR}/cache"
CACHED_VERSION="${CACHE_DIR}/${VERSION}"
SYMLINKS_DIR="${INSTALL_MAESTRO_DIR}/maestro"
SYMLINK="${SYMLINKS_DIR}/${VERSION}"
SYMLINK_TMP="${SYMLINKS_DIR}/${VERSION}.tmp"

if [ -L "${SYMLINK}" ] ; then
    exit 0
fi

mkdir -p "${SYMLINKS_DIR}"
rm -fR "${CACHED_VERSION}"
mkdir -p "${CACHED_VERSION}"
# The standard unzip won't work in a shell pipe, so use the busybox version instead.
curl -L "${GITHUB_URL}" | busybox unzip - -d "${CACHED_VERSION}"
chmod +x "${CACHED_VERSION}/maestro/bin/maestro"

# A renamed symlink is atomic (unlike a rename of a directory).
ln -sf "${CACHED_VERSION}" "${SYMLINK_TMP}"
mv -f "${SYMLINK_TMP}" "${SYMLINK}"
